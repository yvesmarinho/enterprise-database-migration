# ğŸ“ TODO - 16 de Janeiro de 2026

**Data**: 2026-01-16  
**Ãšltima AtualizaÃ§Ã£o**: 2026-01-16 23:00  
**Status**: Atualizado apÃ³s sessÃ£o de troubleshooting Metabase

---

## âœ… ConcluÃ­do Hoje (8 tarefas)

### 1. âœ… Resolver Falha de InicializaÃ§Ã£o Metabase
**Prioridade**: ğŸ”´ CRÃTICA  
**Status**: âœ… **RESOLVIDO**  
**Data ConclusÃ£o**: 2026-01-16 20:30

**Problema**:
- Metabase v0.58.1 com erro de migration
- FK constraint em auth_identity.user_id
- Version mismatch entre backup e app

**SoluÃ§Ã£o Implementada**:
- Restaurado backup 2026-01-16 09:31:54
- Upgrade para Metabase v0.56.19.1
- Corrigidas permissÃµes de 141 tabelas

**Resultado**:
- âœ… Metabase online em https://dashboard.vya.digital
- âœ… Initialization em 1.0 min
- âœ… 7/9 databases conectados

### 2. âœ… Corrigir PermissÃµes metabase_db
**Prioridade**: ğŸ”´ CRÃTICA  
**Status**: âœ… **RESOLVIDO**  
**Data ConclusÃ£o**: 2026-01-16 21:30

**Problema**:
- 141 tabelas owned by yves_marinho
- metabase_user sem privilÃ©gios
- Sequences e views com ownership incorreto

**SoluÃ§Ã£o**:
- Script `fix_metabase_ownership_restored.sql`
- Transfer ownership de 141 tables + 90 sequences + 13 views
- Grant ALL PRIVILEGES
- Default privileges configurados

**VerificaÃ§Ã£o**:
- âœ“ 141 tables com metabase_user
- âœ“ 154 objects com privilÃ©gios corretos
- âœ“ Default privileges OK

### 3. âœ… Criar Sistema fix_permissions
**Prioridade**: ğŸŸ¡ ALTA  
**Status**: âœ… **COMPLETO**  
**Data ConclusÃ£o**: 2026-01-16 22:30

**EntregÃ¡veis**:
- [x] fix_permissions.py (505 linhas)
- [x] fix_permissions.json (4.6K config)
- [x] README.md (291 linhas)
- [x] INDEX.md (6.4K histÃ³rico)
- [x] Testes em metabase_db
- [x] Modos: dry-run, execute, verify

**Resultado**:
- Sistema completo e funcional
- Reduz troubleshooting de horas â†’ minutos
- ReutilizÃ¡vel em 3 databases

### 4. âœ… Documentar SessÃ£o de Troubleshooting
**Prioridade**: ğŸŸ¡ ALTA  
**Status**: âœ… **COMPLETO**  
**Data ConclusÃ£o**: 2026-01-16 23:45

**Arquivos Criados**:
- [x] SESSION_RECOVERY_2026-01-16.md (400+ linhas)
- [x] SESSION_REPORT_2026-01-16.md (500+ linhas)
- [x] FINAL_STATUS_2026-01-16.md (600+ linhas)
- [x] TODAY_ACTIVITIES_20260116.md (300+ linhas)

**ConteÃºdo**:
- Passo a passo de reproduÃ§Ã£o
- RelatÃ³rio completo
- Estado final dos sistemas
- Log de atividades

### 5. âœ… Criar check_metabase_version.py
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Status**: âœ… **COMPLETO**  
**Data ConclusÃ£o**: 2026-01-16 18:30

**Funcionalidade**:
- Analisa versÃ£o do Metabase no backup
- Lista migrations do Liquibase
- Identifica migrations v56
- DiagnÃ³stico de compatibilidade

**Uso**:
```bash
python3 scripts/check_metabase_version.py
```

### 6. âœ… Organizar Arquivos fix_permissions/
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Status**: âœ… **COMPLETO**  
**Data ConclusÃ£o**: 2026-01-16 23:30

**Estrutura Criada**:
```
fix_permissions/
â”œâ”€â”€ fix_permissions.py
â”œâ”€â”€ fix_permissions.json
â”œâ”€â”€ README.md
â”œâ”€â”€ INDEX.md
â”œâ”€â”€ verify_metabase_permissions.py
â”œâ”€â”€ fix_metabase_permissions.sql
â””â”€â”€ fix_metabase_ownership_restored.sql
```

### 7. âœ… Verificar Health Checks Metabase
**Prioridade**: ğŸŸ¡ ALTA  
**Status**: âœ… **VERIFICADO**  
**Data ConclusÃ£o**: 2026-01-16 20:45

**Resultados**:
- âœ… Pesquisas Politicas 121
- âœ… Survey
- âœ… SDRPatriaCidadania
- âœ… DW-Dialer
- âœ… DW-Journey
- âœ… DW-Chat
- âœ… Khomp
- âš ï¸ DW-Dialer-Paschoalotto (timeout)
- âŒ DW-PerfexCRM (RSA key error)

### 8. âœ… Atualizar docker-compose.yaml
**Prioridade**: ğŸ”´ CRÃTICA  
**Status**: âœ… **ATUALIZADO**  
**Data ConclusÃ£o**: 2026-01-16 20:00

**MudanÃ§a**:
```yaml
# Antes
image: metabase/metabase:latest

# Depois
image: metabase/metabase:v0.56.19.1
```

---

## ğŸ”„ Em Progresso (2 tarefas)

### 1. ğŸ”„ Atualizar INDEX.md do Projeto
**Prioridade**: ğŸŸ¡ ALTA  
**ResponsÃ¡vel**: Copilot  
**Estimativa**: 15 min

**Pendente**:
- [ ] Adicionar seÃ§Ã£o fix_permissions/
- [ ] Atualizar seÃ§Ã£o docs/ com SESSION_* files
- [ ] Atualizar links e referÃªncias
- [ ] Verificar estrutura geral

**LocalizaÃ§Ã£o**: `/INDEX.md` (raiz)

### 2. ğŸ”„ Commit Git das MudanÃ§as
**Prioridade**: ğŸŸ¡ ALTA  
**ResponsÃ¡vel**: Copilot  
**Estimativa**: 10 min

**Arquivos para Commit**:
- 17 arquivos novos (scripts, docs, sistema)
- 2 arquivos modificados (docker-compose, INDEX)

**Mensagem Preparada**:
```
feat: Resolve Metabase v0.58.1 issues and create fix_permissions system

- Fix: Metabase v0.58.1 to v0.56.19.1 (stable)
- Add: fix_permissions automation (505 lines Python + JSON)
- Fix: 141 tables ownership (yves_marinho to metabase_user)
- Fix: 154 objects privileges granted
- Add: 7 files in fix_permissions/ folder
- Add: 4 documentation files (SESSION_*, TODAY_ACTIVITIES, TODO)
- Update: INDEX.md with fix_permissions section

Session: 2026-01-16 17:00-23:00
Status: Metabase operational, reusable system created
```

---

## â³ Pendente PrÃ³xima SessÃ£o (10 tarefas)

### Alta Prioridade (4 tarefas)

#### 1. â³ Resolver DW-PerfexCRM RSA Key Error
**Prioridade**: ğŸŸ¡ ALTA  
**Estimativa**: 30 min  
**Bloqueio**: Nenhum

**Problema**:
- Database ID: 11
- Erro: Public Key Retrieval is not allowed
- Metabase nÃ£o consegue conectar

**SoluÃ§Ã£o Proposta**:
1. Atualizar JDBC URL no Metabase
2. Adicionar `allowPublicKeyRetrieval=true`
3. Ou configurar SSL no MySQL
4. Testar conexÃ£o

**Comandos**:
```sql
-- No Metabase Admin
UPDATE metabase_database 
SET details = jsonb_set(
  details, 
  '{additional-options}', 
  '"allowPublicKeyRetrieval=true"'
)
WHERE id = 11;
```

#### 2. â³ Aplicar fix_permissions em n8n_db
**Prioridade**: ğŸŸ¡ ALTA  
**Estimativa**: 20 min  
**DependÃªncias**: fix_permissions system (âœ… pronto)

**Passos**:
1. [ ] Dry-run: `python3 fix_permissions.py --database n8n_db --dry-run`
2. [ ] Revisar output
3. [ ] Execute: `python3 fix_permissions.py --database n8n_db --execute`
4. [ ] Verify: `python3 fix_permissions.py --database n8n_db --verify`

**Objetivo**:
- Corrigir ownership para n8n_user
- Garantir privilÃ©gios corretos
- Configurar default privileges

#### 3. â³ Aplicar fix_permissions em evolution_api
**Prioridade**: ğŸŸ¡ ALTA  
**Estimativa**: 20 min  
**DependÃªncias**: fix_permissions system (âœ… pronto)

**Passos**:
1. [ ] Dry-run: `python3 fix_permissions.py --database evolution_api --dry-run`
2. [ ] Revisar output
3. [ ] Execute: `python3 fix_permissions.py --database evolution_api --execute`
4. [ ] Verify: `python3 fix_permissions.py --database evolution_api --verify`

**Objetivo**:
- Corrigir ownership para evolution_user
- Garantir privilÃ©gios corretos
- Configurar default privileges

#### 4. â³ Monitorar Metabase por 24-48h
**Prioridade**: ğŸŸ¡ ALTA  
**Estimativa**: ContÃ­nuo  
**PerÃ­odo**: 2026-01-17 a 2026-01-18

**Monitoramento**:
- [ ] Initialization time < 2 min
- [ ] Health checks 7/9 OK
- [ ] API response time < 100ms
- [ ] Sem erros em logs
- [ ] Dashboards funcionando

**AÃ§Ãµes se Houver Problemas**:
1. Verificar logs: `temp/metabase.log`
2. Verificar permissions: `fix_permissions.py --verify`
3. Restaurar backup se necessÃ¡rio

### MÃ©dia Prioridade (4 tarefas)

#### 5. â³ Investigar DW-Dialer-Paschoalotto Timeout
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Estimativa**: 45 min  
**Bloqueio**: Nenhum

**Problema**:
- Database ID: 6
- Erro: Connection timeout apÃ³s 60s
- Pode ser network ou firewall

**InvestigaÃ§Ã£o**:
1. [ ] Testar conectividade direto do servidor
2. [ ] Verificar firewall rules
3. [ ] Aumentar timeout no Metabase
4. [ ] Verificar performance do database

**Comandos**:
```bash
# Teste de conectividade
psql -h hostname -p port -U user -d database -c "SELECT 1"

# Verificar latÃªncia
ping hostname
traceroute hostname
```

#### 6. â³ Criar Backup Schedule Automatizado
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Estimativa**: 1h  
**Bloqueio**: Nenhum

**Requisitos**:
- Backup diÃ¡rio de metabase_db
- Retention: 7 dias (diÃ¡rio), 4 semanas (semanal), 12 meses (mensal)
- Formato: pg_dump custom (-Fc)
- VerificaÃ§Ã£o automÃ¡tica de restore

**ImplementaÃ§Ã£o**:
1. [ ] Criar script Python de backup
2. [ ] Adicionar cron job
3. [ ] Configurar rotation policy
4. [ ] Testar restore automatizado

#### 7. â³ Adicionar Testes ao fix_permissions
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Estimativa**: 2h  
**DependÃªncias**: fix_permissions system

**Testes NecessÃ¡rios**:
- [ ] Unit tests para cada funÃ§Ã£o
- [ ] Integration tests com PostgreSQL test instance
- [ ] Validation tests de JSON config
- [ ] Regression tests para casos conhecidos

**Framework**: pytest

#### 8. â³ Documentar Processo de Upgrade Metabase
**Prioridade**: ğŸŸ¢ MÃ‰DIA  
**Estimativa**: 1h  
**Bloqueio**: Nenhum

**ConteÃºdo**:
- [ ] Checklist prÃ©-upgrade
- [ ] Como verificar compatibilidade
- [ ] Processo de backup
- [ ] Steps de upgrade
- [ ] Rollback plan
- [ ] VerificaÃ§Ãµes pÃ³s-upgrade

**Arquivo**: `docs/METABASE_UPGRADE_GUIDE.md`

### Baixa Prioridade (2 tarefas)

#### 9. â³ Criar Dashboard de Monitoramento
**Prioridade**: âšª BAIXA  
**Estimativa**: 3h  
**DependÃªncias**: Grafana ou similar

**MÃ©tricas**:
- Metabase initialization time
- Database health checks status
- API response times
- PostgreSQL connections
- Disk usage

**Ferramentas**: Grafana + Prometheus

#### 10. â³ Training de Equipe no fix_permissions
**Prioridade**: âšª BAIXA  
**Estimativa**: 2h  
**DependÃªncias**: Sistema estÃ¡vel em produÃ§Ã£o

**ConteÃºdo**:
- [ ] Como usar fix_permissions.py
- [ ] Quando aplicar dry-run vs execute
- [ ] Como interpretar outputs
- [ ] Troubleshooting comum
- [ ] Hands-on practice

**Formato**: Workshop + documentaÃ§Ã£o

---

## ğŸš« Bloqueado (0 tarefas)

Nenhuma tarefa bloqueada no momento.

---

## ğŸ”® Backlog Futuro (5 tarefas)

### 1. ğŸ”® Migrar para Infrastructure as Code
**Estimativa**: 1 semana  
**Tecnologia**: Terraform

**Escopo**:
- PostgreSQL configuration
- Metabase deployment
- Networking e DNS
- Backup e monitoring

### 2. ğŸ”® Implementar CI/CD Pipeline
**Estimativa**: 3 dias  
**Tecnologia**: GitHub Actions ou GitLab CI

**Fases**:
- Lint e format check
- Unit tests
- Integration tests
- Deploy to staging
- Deploy to production

### 3. ğŸ”® Criar Disaster Recovery Playbook
**Estimativa**: 2 dias

**ConteÃºdo**:
- Recovery Time Objective (RTO)
- Recovery Point Objective (RPO)
- Backup restoration procedures
- Failover processes
- Contact lists

### 4. ğŸ”® Expandir fix_permissions para Outros Bancos
**Estimativa**: 2 dias

**Databases**:
- PerfexCRM databases
- N8N additional instances
- Future migrations

### 5. ğŸ”® Implementar Monitoring Proativo
**Estimativa**: 1 semana

**Features**:
- Alertas automÃ¡ticos
- Anomaly detection
- Capacity planning
- Performance optimization

---

## ğŸ“Š EstatÃ­sticas

### Status Geral
- **ConcluÃ­do Hoje**: 8 tarefas (100% das crÃ­ticas)
- **Em Progresso**: 2 tarefas (documentaÃ§Ã£o)
- **Pendente**: 10 tarefas (0 bloqueadas)
- **Backlog**: 5 tarefas (futuro)

### Por Prioridade
| Prioridade | ConcluÃ­do | Pendente | Bloqueado | Total |
|------------|-----------|----------|-----------|-------|
| ğŸ”´ CrÃ­tica | 3 | 0 | 0 | 3 |
| ğŸŸ¡ Alta | 3 | 4 | 0 | 7 |
| ğŸŸ¢ MÃ©dia | 2 | 4 | 0 | 6 |
| âšª Baixa | 0 | 2 | 0 | 2 |
| **Total** | **8** | **10** | **0** | **18** |

### Tempo Estimado Pendente
- Alta Prioridade: 1.5h (4 tarefas)
- MÃ©dia Prioridade: 4.75h (4 tarefas)
- Baixa Prioridade: 5h (2 tarefas)
- **Total**: ~11.25h (1.5 dias de trabalho)

---

## ğŸ¯ PrÃ³ximas AÃ§Ãµes Imediatas

### Hoje (Encerramento de SessÃ£o)
1. âœ… Criar documentaÃ§Ã£o SESSION_* - **COMPLETO**
2. ğŸ”„ Atualizar INDEX.md - **EM PROGRESSO**
3. ğŸ”„ Commit git - **EM PROGRESSO**

### AmanhÃ£ (2026-01-17)
1. â³ Monitorar Metabase por estabilidade
2. â³ Resolver DW-PerfexCRM RSA key error
3. â³ Aplicar fix_permissions em n8n_db

### Esta Semana
1. â³ Aplicar fix_permissions em evolution_api
2. â³ Investigar DW-Dialer-Paschoalotto timeout
3. â³ Criar backup schedule automatizado

---

## ğŸ’¡ Notas

### DecisÃµes Importantes
1. **Metabase v0.56.19.1**: Decidido usar ao invÃ©s de v0.58.1 devido a bugs
2. **fix_permissions System**: Criado sistema reutilizÃ¡vel ao invÃ©s de scripts one-off
3. **DocumentaÃ§Ã£o Rica**: Investimento em docs para futuras referÃªncias

### Riscos Mitigados
- âœ… Incompatibilidade de versÃµes Metabase
- âœ… PermissÃµes incorretas PostgreSQL
- âœ… Falta de sistema de recuperaÃ§Ã£o

### Riscos Remanescentes
- âš ï¸ 2 databases nÃ£o conectados (baixo/mÃ©dio impacto)
- âš ï¸ Sem backup automatizado ainda
- âš ï¸ Monitoramento manual

---

## ğŸ“š ReferÃªncias

### DocumentaÃ§Ã£o Relacionada
- [SESSION_RECOVERY_2026-01-16.md](SESSION_RECOVERY_2026-01-16.md)
- [SESSION_REPORT_2026-01-16.md](SESSION_REPORT_2026-01-16.md)
- [FINAL_STATUS_2026-01-16.md](FINAL_STATUS_2026-01-16.md)
- [TODAY_ACTIVITIES_20260116.md](TODAY_ACTIVITIES_20260116.md)
- [fix_permissions/README.md](../fix_permissions/README.md)

### Scripts Criados
- [check_metabase_version.py](../scripts/check_metabase_version.py)
- [fix_permissions.py](../fix_permissions/fix_permissions.py)
- [verify_metabase_permissions.py](../fix_permissions/verify_metabase_permissions.py)

---

**Status**: âœ… **ATUALIZADO E PRONTO PARA PRÃ“XIMA SESSÃƒO**

**PrÃ³xima RevisÃ£o**: 2026-01-17  
**Ãšltima AtualizaÃ§Ã£o**: 2026-01-16 23:00  
**Autor**: Sistema de MigraÃ§Ã£o Enterprise
