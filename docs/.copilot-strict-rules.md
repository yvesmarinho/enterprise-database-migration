# ğŸ¤– Copilot Strict Rules

> **VersÃ£o:** 1.0.0
> **Data:** 11 de dezembro de 2025
> **Escopo:** Enterprise Database Migration System

## ğŸ¯ Objetivo

Definem regras **estritas** para manter a qualidade, consistÃªncia e organizaÃ§Ã£o do cÃ³digo ao trabalhar com GitHub Copilot. Evitam duplicaÃ§Ã£o, garantem padrÃµes e melhoram a eficiÃªncia.

---

## ğŸ“ REGRA 1: OrganizaÃ§Ã£o de Arquivos

### âœ… OBRIGATÃ“RIO

**Cada tipo de arquivo deve ser salvo em sua pasta especÃ­fica:**

```
app/            â†’ CÃ³digo principal da aplicaÃ§Ã£o
  â”œâ”€â”€ core/       â†’ LÃ³gica de migraÃ§Ã£o
  â”œâ”€â”€ cleanup/    â†’ Limpeza de dados
  â””â”€â”€ validation/ â†’ ValidaÃ§Ã£o de dados

cli/            â†’ Scripts e interfaces CLI
  â””â”€â”€ run_migration.py â†’ Entry point principal

components/     â†’ Componentes reutilizÃ¡veis
  â”œâ”€â”€ base_component.py â†’ Base abstrata
  â”œâ”€â”€ config_manager.py â†’ Gerenciamento config
  â””â”€â”€ config_normalizer.py â†’ NormalizaÃ§Ã£o config

orchestrators/  â†’ Orquestradores de processo
  â”œâ”€â”€ migration_orchestrator.py
  â””â”€â”€ orchestrator_pure_python.py

validation/     â†’ Validadores e verificadores
  â”œâ”€â”€ verify_*.py â†’ Scripts de verificaÃ§Ã£o
  â””â”€â”€ *_validator.py â†’ Classes validadoras

config/         â†’ Arquivos de configuraÃ§Ã£o
  â”œâ”€â”€ *.json     â†’ ConfiguraÃ§Ãµes estruturadas
  â”œâ”€â”€ *.yaml     â†’ ConfiguraÃ§Ãµes YAML
  â””â”€â”€ templates/ â†’ Templates

scripts/        â†’ Scripts shell e automaÃ§Ã£o
  â”œâ”€â”€ *.sh     â†’ Scripts shell
  â””â”€â”€ *.bash   â†’ Scripts bash

docs/           â†’ DocumentaÃ§Ã£o
  â”œâ”€â”€ *.md     â†’ DocumentaÃ§Ã£o Markdown
  â”œâ”€â”€ SESSION_REPORT_*.md â†’ RelatÃ³rios de sessÃ£o
  â””â”€â”€ STATUS_*.md â†’ Status do sistema

secrets/        â†’ ConfiguraÃ§Ãµes sensÃ­veis (GIT-IGNORED)
  â”œâ”€â”€ *_config.json
  â””â”€â”€ *_secrets.json

utils/          â†’ FunÃ§Ãµes utilitÃ¡rias
  â”œâ”€â”€ *_util.py â†’ UtilitÃ¡rios diversos
  â””â”€â”€ *_helper.py â†’ FunÃ§Ãµes auxiliares

test/           â†’ Testes unitÃ¡rios
  â”œâ”€â”€ test_*.py â†’ Testes
  â””â”€â”€ analise_*.py â†’ Scripts anÃ¡lise
```

### âŒ PROIBIDO

- **NÃ£o** criar arquivos Python na raiz do projeto
- **NÃ£o** deixar scripts de teste soltos na raiz
- **NÃ£o** criar subdiretorios adicionais sem aprovaÃ§Ã£o
- **NÃ£o** misturar tipos de arquivo em pastas erradas

### ğŸ“‹ Exemplo de ViolaÃ§Ã£o (CORRIGIR)

```
âŒ ERRADO (na raiz):
- user_migration.py â†’ Deve estar em: app/core/user_migration.py
- my_validator.py â†’ Deve estar em: validation/my_validator.py
- util_functions.py â†’ Deve estar em: utils/util_functions.py

âœ… CORRETO:
- app/core/user_migration.py
- validation/my_validator.py
- utils/util_functions.py
```

---

## ğŸ—ï¸ REGRA 2: PadrÃµes de Nomenclatura

### âœ… OBRIGATÃ“RIO

#### Arquivo Python
```python
# âœ… CORRETO
core/user_migration.py
orchestrators/migration_orchestrator.py
validation/data_validator.py
utils/database_util.py
components/config_manager.py
cli/run_migration.py

# âŒ ERRADO
core/UserMigration.py              # Use snake_case
orchestrators/migration.py         # Especifique o tipo (_orchestrator)
validation/validator.py            # Especifique o propÃ³sito
utils/helper.py                    # Especifique o tipo (_util)
```

#### Classe Python
```python
# âœ… CORRETO
class UserMigrator:
    """Migra usuÃ¡rios de origem para destino."""

class DatabaseValidator:
    """Valida integridade do banco de dados."""

class ConfigManager:
    """Gerencia configuraÃ§Ãµes do sistema."""

# âŒ ERRADO
class user_migrator:            # Use PascalCase
class Validator:                # Especifique o propÃ³sito
class MyUtility:                # Use nomes descritivos
```

#### FunÃ§Ãµes Python
```python
# âœ… CORRETO
def migrate_users(source_conn, dest_conn):
    """Migra usuÃ¡rios."""

def validate_data_integrity(connection):
    """Valida integridade dos dados."""

def get_database_config(env_name):
    """Retorna configuraÃ§Ã£o do banco."""

# âŒ ERRADO
def migrateUsers(source, dest):      # Use snake_case
def validate():                      # Especifique o propÃ³sito
def get(name):                       # Nomes genÃ©ricos
```

#### Arquivos de ConfiguraÃ§Ã£o
```
# âœ… CORRETO
config/migration_config.json
config/migration_rules.json
secrets/postgresql_source_config.json
secrets/postgresql_destination_config.json
mcp-questions.yaml
objetivo.yaml

# âŒ ERRADO
config.json                    # Especifique o propÃ³sito
settings.yaml                  # Use naming scheme
source.json                    # Muito genÃ©rico
```

#### DocumentaÃ§Ã£o
```
# âœ… CORRETO
docs/SESSION_REPORT_20251211.md
docs/STATUS_SISTEMA.md
docs/SESSION_RECOVERY_20251211.md
docs/SETUP_GUIDE.md

# âŒ ERRADO
docs/report.md                    # Especifique o tipo
docs/status.md                    # Use maiÃºsculas para tÃ­tulos
docs/Note.txt                     # Use .md para documentaÃ§Ã£o
```

---

## ğŸ’» REGRA 3: PadrÃµes de CÃ³digo

### âœ… OBRIGATÃ“RIO

#### Imports
```python
# âœ… CORRETO - Ordenar: stdlib, third-party, local
import json
import logging
from pathlib import Path
from typing import Dict, List, Any

import psycopg2
from sqlalchemy import create_engine

from app.core.migration import DatabaseMigrator
from config_manager import ConfigManager
from utils.database_util import get_connection_string

# âŒ ERRADO
from app.core.migration import *  # NÃ£o use wildcard imports
import os, sys, json              # Uma importaÃ§Ã£o por linha
from utils import *               # Imports genÃ©ricos
```

#### Docstrings
```python
# âœ… CORRETO
class UserMigrator:
    """Migra usuÃ¡rios de banco de dados origem para destino.

    Attributes:
        source_conn: ConexÃ£o com banco de origem
        dest_conn: ConexÃ£o com banco de destino
        logger: Logger para eventos
    """

    def migrate(self):
        """Executa migraÃ§Ã£o de usuÃ¡rios.

        Returns:
            Dict: Resultado da migraÃ§Ã£o {'success': bool, 'count': int}

        Raises:
            ConnectionError: Se conexÃ£o falhar
            ValidationError: Se dados sÃ£o invÃ¡lidos
        """

# âŒ ERRADO
class UserMigrator:
    pass  # Sem docstring

def migrate():
    # Faz migraÃ§Ã£o
    pass  # Sem docstring formal
```

#### Type Hints
```python
# âœ… CORRETO
from typing import Dict, List, Optional, Tuple

def process_users(
    users: List[Dict[str, Any]],
    rules: Dict[str, str]
) -> Tuple[int, int]:
    """Processa usuÃ¡rios com regras.

    Args:
        users: Lista de usuÃ¡rios
        rules: Regras de processamento

    Returns:
        Tupla (sucesso, falhas)
    """
    success = 0
    failures = 0
    return success, failures

# âŒ ERRADO
def process_users(users, rules):  # Sem type hints
    pass

def migrate(data):  # Tipos nÃ£o especificados
    return data
```

#### Logging
```python
# âœ… CORRETO
import logging

logger = logging.getLogger(__name__)

logger.info("Iniciando migraÃ§Ã£o de usuÃ¡rios")
logger.debug(f"Migrando usuÃ¡rio: {user_id}")
logger.warning("PrivilÃ©gio nÃ£o encontrado, continuando")
logger.error(f"Falha ao migrar usuÃ¡rio: {user_id}", exc_info=True)

# âŒ ERRADO
print("Migrando usuÃ¡rio")      # NÃ£o use print
logger.log("Iniciando")         # Use nÃ­veis corretos
print(f"DEBUG: {data}")         # Debug deve ser logger.debug
```

#### Error Handling
```python
# âœ… CORRETO
try:
    connection = create_engine(db_url)
except ConnectionError as e:
    logger.error(f"Falha ao conectar: {str(e)}", exc_info=True)
    raise

try:
    execute_migration(connection)
except Exception as e:
    logger.error("Erro durante migraÃ§Ã£o", exc_info=True)
    raise MigrationError(f"MigraÃ§Ã£o falhou: {str(e)}") from e

# âŒ ERRADO
try:
    execute_migration(connection)
except:  # GenÃ©rico demais
    print("Erro!")

try:
    execute_migration(connection)
except Exception:  # Sem logging
    pass
```

---

## ğŸ“Š REGRA 4: Estrutura de Componentes

### âœ… OBRIGATÃ“RIO

#### Arquivo de Componente
```python
# âœ… CORRETO - app/core/user_migration.py

"""MÃ³dulo para migraÃ§Ã£o de usuÃ¡rios."""

import logging
from typing import Dict, List, Any
from sqlalchemy import Engine

from components.base_component import BaseComponent
from utils.database_util import execute_query

logger = logging.getLogger(__name__)


class UserMigrator(BaseComponent):
    """Migra usuÃ¡rios de origem para destino."""

    def __init__(self, source_engine: Engine, dest_engine: Engine):
        """Inicializa migrador.

        Args:
            source_engine: Engine SQLAlchemy origem
            dest_engine: Engine SQLAlchemy destino
        """
        super().__init__()
        self.source_engine = source_engine
        self.dest_engine = dest_engine

    def migrate(self) -> Dict[str, Any]:
        """Executa migraÃ§Ã£o.

        Returns:
            Dict com status e estatÃ­sticas
        """
        logger.info("Iniciando migraÃ§Ã£o de usuÃ¡rios")
        try:
            # ImplementaÃ§Ã£o
            result = {'success': True, 'count': 0}
            logger.info(f"MigraÃ§Ã£o completada: {result}")
            return result
        except Exception as e:
            logger.error(f"Erro na migraÃ§Ã£o: {str(e)}", exc_info=True)
            raise

# âŒ ERRADO
class UserMigrator:
    pass  # Sem heranÃ§a, documentaÃ§Ã£o ou tipos

def migrate_users():  # FunÃ§Ã£o solta
    print("Migrando")

user_migrator = UserMigrator()  # InstÃ¢ncia global
```

#### Arquivo CLI
```python
# âœ… CORRETO - cli/run_migration.py

"""Interface CLI para migraÃ§Ã£o."""

import argparse
import logging
import sys
from pathlib import Path

from app.core.migration import DatabaseMigrator
from components.config_manager import ConfigManager

logger = logging.getLogger(__name__)


def main():
    """FunÃ§Ã£o principal CLI."""
    parser = argparse.ArgumentParser(
        description="Executa migraÃ§Ã£o de banco de dados"
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Executar sem fazer alteraÃ§Ãµes"
    )
    parser.add_argument(
        "--verbose",
        action="store_true",
        help="Modo verbose"
    )

    args = parser.parse_args()

    try:
        config = ConfigManager().load()
        migrator = DatabaseMigrator(config)
        result = migrator.run(dry_run=args.dry_run)
        sys.exit(0 if result.get('success') else 1)
    except Exception as e:
        logger.error(f"Erro: {str(e)}", exc_info=True)
        sys.exit(1)


if __name__ == "__main__":
    main()

# âŒ ERRADO
def run():  # Nome nÃ£o descritivo
    migrate()  # Sem argumentos
    print("Done")  # Sem logging
```

---

## ğŸ§ª REGRA 5: Testes e ValidaÃ§Ã£o

### âœ… OBRIGATÃ“RIO

#### Arquivo de Teste
```python
# âœ… CORRETO - test/test_user_migration.py

"""Testes para migraÃ§Ã£o de usuÃ¡rios."""

import pytest
from unittest.mock import Mock, patch, MagicMock

from app.core.user_migration import UserMigrator
from utils.database_util import DatabaseConnection


class TestUserMigrator:
    """Testes da classe UserMigrator."""

    @pytest.fixture
    def migrator(self):
        """Fixture para migrador."""
        source = Mock()
        dest = Mock()
        return UserMigrator(source, dest)

    def test_migrate_success(self, migrator):
        """Testa migraÃ§Ã£o bem-sucedida."""
        result = migrator.migrate()
        assert result['success'] is True
        assert result['count'] > 0

    def test_migrate_connection_error(self, migrator):
        """Testa erro de conexÃ£o."""
        migrator.source_engine.connect.side_effect = Exception("Connection failed")

        with pytest.raises(Exception):
            migrator.migrate()

    @patch('app.core.user_migration.logger')
    def test_logging(self, mock_logger, migrator):
        """Testa logging."""
        migrator.migrate()
        assert mock_logger.info.called

# âŒ ERRADO
def test_migration():  # Nome nÃ£o descritivo
    result = migrate()  # Sem setup
    assert result  # AsserÃ§Ã£o fraca

class TestMigration:  # Sem docstring
    def test():  # Sem self
        pass
```

#### Script de AnÃ¡lise (test/)
```python
# âœ… CORRETO - test/analyze_migration.py

"""Script para anÃ¡lise de resultados de migraÃ§Ã£o."""

import json
import logging
from pathlib import Path
from typing import Dict, Any

logger = logging.getLogger(__name__)


def analyze_results(report_path: str) -> Dict[str, Any]:
    """Analisa resultados de migraÃ§Ã£o.

    Args:
        report_path: Caminho do relatÃ³rio JSON

    Returns:
        Dict com anÃ¡lise
    """
    with open(report_path, 'r') as f:
        data = json.load(f)

    # AnÃ¡lise
    analysis = {
        'total': len(data),
        'success': sum(1 for x in data if x.get('success')),
        'failed': sum(1 for x in data if not x.get('success')),
    }

    logger.info(f"AnÃ¡lise concluÃ­da: {analysis}")
    return analysis


if __name__ == "__main__":
    result = analyze_results("reports/migration_20251211.json")
    print(json.dumps(result, indent=2))

# âŒ ERRADO
# Arquivo solto na raiz "analise_migration.py"
# Sem tipo hints ou docstrings
# print() em vez de logger
```

---

## ğŸ“ REGRA 6: DocumentaÃ§Ã£o

### âœ… OBRIGATÃ“RIO

#### Markdown de SessÃ£o
```markdown
# ğŸ“Š SESSION_REPORT_20251211.md

## âœ… O que foi feito
- Item 1
- Item 2

## âš ï¸ Problemas encontrados
- Problema 1
- Problema 2

## ğŸ”„ PrÃ³ximas aÃ§Ãµes
- AÃ§Ã£o 1
- AÃ§Ã£o 2

## ğŸ“Š EstatÃ­sticas
- MÃ©trica 1: Valor
- MÃ©trica 2: Valor
```

#### Markdown de Status
```markdown
# ğŸ“Š STATUS_SISTEMA_20251211.md

## ğŸš€ Status Geral
- [x] Componente 1
- [x] Componente 2
- [ ] Componente 3

## ğŸ“ˆ Progresso
- Percentual: XX%

## ğŸ”— ReferÃªncias
- Arquivo relevante
```

#### Markdown de RecuperaÃ§Ã£o de SessÃ£o
```markdown
# ğŸ”„ SESSION_RECOVERY_20251211.md

## ğŸ“‹ Dados Recuperados
- MemÃ³ria MCP: Status
- Arquivos: Status
- ConfiguraÃ§Ãµes: Status

## ğŸ¯ PrÃ³ximas AÃ§Ãµes
1. AÃ§Ã£o 1
2. AÃ§Ã£o 2
```

---

## ğŸ” REGRA 7: SeguranÃ§a

### âœ… OBRIGATÃ“RIO

#### Gerenciamento de Secrets
```python
# âœ… CORRETO
import os
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = os.getenv('DATABASE_URL')
API_KEY = os.getenv('API_KEY')

if not DATABASE_URL:
    raise ValueError("DATABASE_URL nÃ£o definida em .env")

# âŒ ERRADO
DATABASE_URL = "postgresql://user:password@localhost/db"  # Hardcoded!
API_KEY = "sk-1234567890abcdef"  # Exposto!
```

#### Arquivo .gitignore
```
# âœ… Deve ignorar:
secrets/
.env
.env.local
*.pyc
__pycache__/
.venv/
```

#### ConfiguraÃ§Ãµes SensÃ­veis
```python
# âœ… CORRETO - secrets/postgresql_destination_config.json
{
    "host": "${DB_HOST}",
    "port": 5432,
    "user": "${DB_USER}",
    "password": "${DB_PASSWORD}"
}

# Usar no cÃ³digo:
import json
import os
from pathlib import Path

with open('secrets/postgresql_destination_config.json') as f:
    config = json.load(f)

# Substituir variÃ¡veis de ambiente
config['host'] = os.getenv('DB_HOST', config['host'])
```

---

## ğŸ”„ REGRA 8: Versionamento e Commits

### âœ… OBRIGATÃ“RIO

#### Mensagens de Commit
```bash
# âœ… CORRETO
git commit -m "feat: adicionar migrador de usuÃ¡rios"
git commit -m "fix: corrigir erro de conexÃ£o em UserMigrator"
git commit -m "docs: atualizar README com instruÃ§Ãµes de setup"
git commit -m "test: adicionar testes para validaÃ§Ã£o de dados"
git commit -m "refactor: reorganizar imports em components/"

# âŒ ERRADO
git commit -m "fix"
git commit -m "AlteraÃ§Ã£o"
git commit -m "WIP: trabalho em progresso"
```

#### Branch Names
```bash
# âœ… CORRETO
git checkout -b feature/user-migration
git checkout -b fix/connection-error
git checkout -b docs/update-readme
git checkout -b refactor/organize-imports

# âŒ ERRADO
git checkout -b develop-user-fix
git checkout -b fix_something
git checkout -b test123
```

---

## ğŸ¤– REGRA 9: IntegraÃ§Ã£o com Copilot

### âœ… OBRIGATÃ“RIO

#### Como o Copilot Deve Sugerir CÃ³digo

```python
# âœ… CORRETO - Copilot entende o contexto
# Arquivo: app/core/grants_migration.py
# Copilot sugere:

class GrantsMigrator(BaseComponent):
    """Migra grants do banco origem para destino."""

    def __init__(self, source_engine: Engine, dest_engine: Engine):
        super().__init__()
        self.source_engine = source_engine
        self.dest_engine = dest_engine
        self.logger = logging.getLogger(__name__)

    def migrate_grants(self) -> Dict[str, Any]:
        """Migra grants."""
        # Copilot sugere queries SQL corretas
        # Copilot sugere error handling apropriado
        # Copilot sugere logging em todos os pontos
```

#### Como CRIAR Arquivo para Copilot Sugerir Bem

```
1. âœ… Escolha a pasta correta:
   - app/core/ â†’ Copilot sugere migrations
   - validation/ â†’ Copilot sugere validators
   - orchestrators/ â†’ Copilot sugere orchestrators

2. âœ… Use nome descritivo:
   - grants_migration.py â†’ Copilot entende que Ã© migraÃ§Ã£o de grants
   - data_validator.py â†’ Copilot entende validaÃ§Ã£o

3. âœ… Herde de classe base:
   - class GrantsMigrator(BaseComponent) â†’ Copilot sugere padrÃ£o

4. âœ… Adicione docstrings:
   - """Migra grants do banco dados.""" â†’ Copilot entende intenÃ§Ã£o

5. âœ… Use type hints:
   - def migrate(self) -> Dict[str, Any] â†’ Copilot sugere retorno correto
```

---

## âœ”ï¸ CHECKLIST DE CRIAÃ‡ÃƒO DE ARQUIVO

Antes de criar qualquer arquivo novo:

- [ ] Escolhi a pasta certa? (app/, cli/, validation/, etc)
- [ ] Usei nome descritivo? (sufixo _migration, _validator, etc)
- [ ] Adicionei docstring no mÃ³dulo?
- [ ] Usei type hints em funÃ§Ãµes?
- [ ] Coloquei logging apropriadamente?
- [ ] Implementei error handling?
- [ ] Criei testes em test/?
- [ ] Documentei em docs/?
- [ ] Segui convenÃ§Ãµes de nomenclatura?
- [ ] NÃ£o deixei na raiz do projeto?

---

## ğŸ“Œ Resumo das Regras

| Regra | DescriÃ§Ã£o | Prioridade |
|-------|-----------|-----------|
| 1 | OrganizaÃ§Ã£o de Arquivos | ğŸ”´ **CRÃTICA** |
| 2 | PadrÃµes de Nomenclatura | ğŸ”´ **CRÃTICA** |
| 3 | PadrÃµes de CÃ³digo | ğŸŸ  **ALTA** |
| 4 | Estrutura de Componentes | ğŸŸ  **ALTA** |
| 5 | Testes e ValidaÃ§Ã£o | ğŸŸ¡ **MÃ‰DIA** |
| 6 | DocumentaÃ§Ã£o | ğŸŸ¡ **MÃ‰DIA** |
| 7 | SeguranÃ§a | ğŸ”´ **CRÃTICA** |
| 8 | Versionamento | ğŸŸ¡ **MÃ‰DIA** |
| 9 | IntegraÃ§Ã£o Copilot | ğŸŸ¡ **MÃ‰DIA** |

---

## ğŸš€ Como Usar Este Documento

1. **Antes de criar arquivo:** Consulte REGRA 1 + CHECKLIST
2. **Durante desenvolvimento:** Consulte REGRA 3 + REGRA 5
3. **Antes de commit:** Consulte REGRA 8 + CHECKLIST
4. **Ao trabalhar com Copilot:** Consulte REGRA 9

---

## ğŸ“ DÃºvidas Frequentes

### "Onde devo salvar meu novo arquivo?"
â†’ Consulte REGRA 1: OrganizaÃ§Ã£o de Arquivos

### "Como devo nomear minha classe?"
â†’ Consulte REGRA 2: PadrÃµes de Nomenclatura

### "Copilot estÃ¡ sugerindo cÃ³digo ruim"
â†’ Consulte REGRA 9: IntegraÃ§Ã£o com Copilot (provavelmente pasta errada)

### "Esqueci de adicionar documentaÃ§Ã£o"
â†’ Consulte REGRA 6: DocumentaÃ§Ã£o

### "Preciso salvar um secret"
â†’ Consulte REGRA 7: SeguranÃ§a â†’ secrets/ + .env

---

**VersÃ£o:** 1.0.0
**Data:** 11 de dezembro de 2025
**Status:** âœ… ATIVO
